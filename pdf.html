
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lightweight PDF Viewer + Annotator</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<!-- pdf.js & pdf-lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
  const pdfjsLib = window['pdfjs-dist/build/pdf']; // v3 UMD global
  // (With the worker <script> present, you don’t have to set workerSrc.)
</script>

<style>
/* ====== Copy of your Modern Editor header/button look (stacked left) ====== */
:root{
  --font-serif:'Georgia','Times New Roman',serif;
  --font-sans:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  --bg-color:#fffff8;
  --text-color:#1a1a1a;
  --border-color:#d4d4d4;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font-serif);background:var(--bg-color);color:var(--text-color);min-height:100vh;overflow:hidden}
/* Left header column */
.header{
  position:fixed;top:2rem;left:0;z-index:50;padding:16px;display:grid;grid-template-columns:repeat(2,52px);grid-auto-rows:min-content;gap:8px 10px;width:auto;justify-items:center;
}
.reader .header{opacity:0;pointer-events:none;transform:translateX(-120%);transition:opacity .2s ease,transform .25s ease;}
.toolbar-sep{grid-column:1/span 2;height:16px}
.span-2{grid-column:span 2;justify-self:stretch;display:flex;align-items:center;justify-content:center;width:100%}
.hamburger-btn,.icon-btn,.nav-btn{
  background:#111;
  color:#fff;
  border:1px solid #000;
  cursor:pointer;border-radius:4px;box-shadow:0 3px 6px rgba(0,0,0,.35);
  transition:background .2s,color .2s,box-shadow .2s,width .2s;
  width:44px;height:44px;display:flex;align-items:center;justify-content:center;line-height:1;padding:6px;font-size:1rem;
}
.nav-btn.span-2{width:100%;}
.hamburger-btn:hover,.icon-btn:hover,.nav-btn:hover:not(:disabled){background:#1f1f1f;box-shadow:0 4px 10px rgba(0,0,0,.4)}
.nav-btn.active{background:#2563eb;color:#fff;box-shadow:0 4px 12px rgba(37,99,235,.45);border-color:#1d4ed8;}
.icon-btn i{pointer-events:none;font-size:1.3em;line-height:1;width:100%;text-align:center;}
.icon-btn img{pointer-events:none;width:26px;height:26px;display:block;}
.nav-btn.needs-file{background:#2563eb;color:#fff;border-color:#1d4ed8;box-shadow:0 4px 10px rgba(37,99,235,.45);}
#toggleReaderBtn i{margin:0 auto;font-size:1.4em;}
.nav-btn:disabled{opacity:.5;cursor:not-allowed}
/* Tiny info pill */
.nav-info{background:#111;border:1px solid #000;border-radius:4px;padding:4px 8px;text-align:center;font-size:.85rem;font-family:var(--font-sans);color:#f5f5f5;font-weight:500;box-shadow:0 3px 6px rgba(0,0,0,.35)}

/* ====== Viewer area ====== */
.app{display:flex;height:100vh;width:100vw}
.main{flex:1;overflow:auto;padding:24px 24px 48px 84px; /* left pad for toolbar */}
.reader .main{padding:16px 24px 32px 24px}
#pages{position:relative;display:flex;flex-direction:column;align-items:center;gap:16px}
.page{position:relative;box-shadow:0 2px 8px rgba(0,0,0,.1);background:#fff}
.page canvas{display:block;background:#fff}
.layer{position:absolute;inset:0;pointer-events:auto}
.reader .layer{display:none} /* hide annotation layer in reader */

/* Annotation elements: transparent, borderless by default */
.text-anno,.sig-anno,.comment-pin{position:absolute;pointer-events:auto;cursor:move}
.text-anno{background:transparent;border:none;min-width:120px;min-height:24px;outline:none;color:#000}
.text-anno::placeholder{color:#999}
.text-anno:focus,.text-anno.selected,.sig-anno.selected,.comment-pin.selected{outline:2px solid #2563eb;outline-offset:1px;border-radius:4px}
.sig-anno{background:transparent;border:none;display:inline-flex;align-items:stretch;justify-content:stretch;}
.sig-anno img{display:block;width:100%;height:100%;object-fit:contain}
.sig-anno .resize-handle{position:absolute;right:-6px;bottom:-6px;width:16px;height:16px;border-radius:50%;background:#2563eb;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.35);cursor:se-resize;opacity:0;transition:opacity .2s ease;}
.sig-anno:hover .resize-handle,.sig-anno.selected .resize-handle{opacity:1;}
.comment-pin{width:22px;height:22px;border-radius:50%;background:#ffd166;border:1px solid #f4a261;display:flex;align-items:center;justify-content:center;font-weight:700;color:#333}

/* Comment sidebar (opens on right) */
#commentSidebar{position:fixed;top:0;right:-380px;width:360px;height:100vh;background:#fff;border-left:1px solid var(--border-color);box-shadow:-10px 0 30px rgba(0,0,0,.15);transition:right .25s;z-index:60;display:flex;flex-direction:column}
#commentSidebar.open{right:0}
.cs-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border-color);font-family:var(--font-sans)}
.cs-thread{flex:1;overflow:auto;padding:10px 14px}
.cs-item{border-bottom:1px solid #eee;padding:8px 0}
.cs-item:last-child{border-bottom:none}
.cs-author{font-weight:600;color:#2563eb;font-size:.85rem}
.cs-time{font-size:.75rem;color:#666}
.cs-text{white-space:pre-wrap;margin-top:2px}
.cs-input{border-top:1px solid var(--border-color);padding:10px 14px}
.cs-input input,.cs-input textarea{width:100%;border:1px solid #ccc;border-radius:6px;padding:8px;margin-bottom:8px;font-family:inherit;font-size:14px}
.cs-actions{display:flex;gap:8px}
.cs-actions .nav-btn{flex:1;height:36px;width:auto}

/* Reader controls hint (top-right) */
.reader-hint{position:fixed;top:10px;right:12px;z-index:40;background:rgba(255,255,255,.9);border:1px solid var(--border-color);border-radius:6px;padding:6px 10px;font-family:var(--font-sans);font-size:.8rem;color:#444;display:none}
.reader .reader-hint{display:block}

/* Page indicator pill */
#pageInfo{background:#111;border:1px solid #000;border-radius:14px;padding:4px 8px;font-size:.75rem;font-family:var(--font-sans);color:#f5f5f5;box-shadow:0 3px 6px rgba(0,0,0,.35)}
#leftBar #pageInfo{grid-column:span 2;justify-self:stretch;display:flex;align-items:center;justify-content:center;height:44px;}
#leftBar .span-2{justify-self:stretch}

.nav-btn.primary-btn{background:#2563eb;color:#fff;border-color:#1d4ed8;box-shadow:0 4px 12px rgba(37,99,235,.45);}
.nav-btn.primary-btn:hover{background:#1d4ed8;color:#fff}
.nav-btn.ghost-btn{background:#f5f5f5;color:#1a1a1a;border-color:#d4d4d4;box-shadow:0 2px 4px rgba(0,0,0,.1);}
.nav-btn.ghost-btn:hover{background:#fff;box-shadow:0 3px 6px rgba(0,0,0,.18)}

/* Hidden file input */
#file{display:none}

@media (max-width: 800px){
  .main{padding-left:72px}
  .header{grid-template-columns:repeat(2,46px);}
  .hamburger-btn,.icon-btn,.nav-btn{width:38px;height:38px}
}

.hidden{display:none !important;}
.floating-panel{
  position:fixed;
  z-index:120;
  background:#fff;
  border:1px solid var(--border-color);
  border-radius:8px;
  padding:10px 12px;
  box-shadow:0 12px 28px rgba(0,0,0,.25);
  display:flex;
  gap:10px;
  align-items:center;
  font-family:var(--font-sans);
}
.floating-panel label{display:flex;flex-direction:column;font-size:.75rem;gap:4px;color:#333;min-width:90px}
.floating-panel select,.floating-panel input[type="number"]{border:1px solid #ccc;border-radius:6px;padding:4px 6px;font-size:.85rem;font-family:inherit}
.floating-panel input[type="color"]{width:36px;height:24px;border:none;background:transparent;padding:0}
.toggle-row{display:flex;gap:6px;align-items:center}
.mini-btn{
  width:28px;height:28px;border-radius:6px;border:1px solid var(--border-color);
  background:#f5f5f5;cursor:pointer;font-weight:600;font-family:var(--font-sans);
  display:flex;align-items:center;justify-content:center;font-size:.9rem;line-height:1;
}
.mini-btn.active{background:#2563eb;color:#fff;border-color:#1d4ed8}
.mini-btn i{pointer-events:none;}
.color-row{display:flex;align-items:center;gap:6px;font-size:.75rem;color:#333}

.signature-modal{
  position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:130;
}
.signature-card{
  background:#fff;padding:20px;border-radius:12px;box-shadow:0 18px 45px rgba(0,0,0,.35);width:min(90vw,460px);display:flex;flex-direction:column;gap:12px;font-family:var(--font-sans);
}
.signature-card header{display:flex;align-items:center;justify-content:space-between}
.signature-card h2{font-size:1.1rem;font-weight:600}
.identity-field{display:flex;flex-direction:column;gap:6px;font-size:.85rem;color:#333}
.identity-field input{border:1px solid #d4d4d4;border-radius:6px;padding:8px;font-size:1rem;font-family:var(--font-sans)}
.signature-label{font-size:.85rem;color:#555}
.signature-card canvas{width:100%;height:auto;border:1px solid #d4d4d4;border-radius:8px;background:#fff;cursor:crosshair;touch-action:none}
.signature-actions{display:flex;gap:10px;justify-content:space-between}
.signature-actions .nav-btn{width:auto;height:36px;font-size:.85rem;padding:0 16px;line-height:1;box-shadow:none}
.signature-actions .nav-btn.primary-btn{box-shadow:none}
.signature-hint{font-size:.75rem;color:#555;text-align:left}
.cs-author-line{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;font-family:var(--font-sans);font-size:.85rem;color:#444}
.cs-author-line strong{color:#2563eb}
.cs-author-line .mini-btn{min-width:32px;height:32px;font-size:1rem}

.help-modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:140;}
.help-card{background:#fff;border-radius:12px;box-shadow:0 18px 45px rgba(0,0,0,.35);width:min(92vw,420px);max-height:90vh;display:flex;flex-direction:column;font-family:var(--font-sans);}
.help-header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border-color);}
.help-header h2{font-size:1.1rem;font-weight:600;color:#1a1a1a;}
.help-body{padding:18px 20px 22px 20px;overflow:auto;font-size:.9rem;color:#333;display:flex;flex-direction:column;gap:14px;}
.help-body h3{font-size:.95rem;font-weight:600;margin-bottom:4px;color:#1a1a1a;}
.help-body ul{padding-left:18px;display:flex;flex-direction:column;gap:6px;}
.help-body li strong{font-weight:600;color:#1a1a1a;}

body.annotations-hidden .layer{display:none !important;}
body.annotations-hidden #commentSidebar{right:-380px !important;}
body.annotations-hidden .floating-panel{display:none !important;}
</style>
</head>
<body>
<div class="app">
  <!-- Left toolbar (icons copied style) -->
  <div class="header" id="leftBar">
    <!-- Open/Save -->
    <button class="nav-btn icon-btn" id="openBtn" title="Open PDF">
      <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA2NCA2NCc+PHJlY3Qgd2lkdGg9JzY0JyBoZWlnaHQ9JzY0JyByeD0nMTAnIGZpbGw9JyMyZjJmMmYnLz48cGF0aCBmaWxsPScjZmZmZmZmJyBkPSdNMTQgMjJoMTZsNSA3aDIxYTQgNCAwIDAgMSA0IDR2MTlhNCA0IDAgMCAxLTQgNEgxNGE0IDQgMCAwIDEtNC00VjI2YTQgNCAwIDAgMSA0LTR6Jy8+PHBhdGggZmlsbD0nI2ZmZmZmZicgZD0nTTMwIDEybDEwIDEwaC02djE0aC04VjIyaC02eicvPjwvc3ZnPg==" alt="Open icon"/>
    </button>
    <input id="file" type="file" accept="application/pdf"/>
    <button class="nav-btn icon-btn" id="saveBtn" title="Save PDF (with comments/text/signatures)" disabled>
      <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA2NCA2NCc+PHJlY3Qgd2lkdGg9JzY0JyBoZWlnaHQ9JzY0JyByeD0nMTAnIGZpbGw9JyMyZjJmMmYnLz48cGF0aCBmaWxsPScjZmZmZmZmJyBkPSdNMTQgMTRoMzZhNCA0IDAgMCAxIDQgNHYxNmgtOFYyMkgxOHYzMGgxMHYtOGg4djhoMTB2LThoOHYxMGE0IDQgMCAwIDEtNCA0SDE0YTQgNCAwIDAgMS00LTRWMThhNCA0IDAgMCAxIDQtNHonLz48cGF0aCBmaWxsPScjZmZmZmZmJyBkPSdNMzIgMTJsMTIgMTJoLTh2MTZoLThWMjRoLTh6Jy8+PC9zdmc+" alt="Save icon"/>
    </button>
    <div class="toolbar-sep" aria-hidden="true"></div>
    <button class="nav-btn icon-btn" id="identityBtn" title="Set name & signature">
      <i class="fa-solid fa-user"></i>
    </button>
    <button class="nav-btn icon-btn" id="textTool" title="Add text (T – one time)">
      <i class="fa-solid fa-font"></i>
    </button>
    <button class="nav-btn icon-btn" id="commentTool" title="Add comment (M – one time)">
      <i class="fa-solid fa-comment-dots"></i>
    </button>
    <button class="nav-btn icon-btn" id="signatureTool" title="Add signature (S – one time)">
      <i class="fa-solid fa-pen-fancy"></i>
    </button>
    <div class="toolbar-sep" aria-hidden="true"></div>
    <button class="nav-btn icon-btn" id="zoomOutBtn" title="Zoom out (-)">
      <i class="fa-solid fa-magnifying-glass-minus"></i>
    </button>
    <button class="nav-btn icon-btn" id="zoomInBtn" title="Zoom in (+)">
      <i class="fa-solid fa-magnifying-glass-plus"></i>
    </button>
    <div id="pageInfo" class="nav-info">1 / 1 · 100%</div>
    <button class="nav-btn icon-btn" id="prevPageBtn" title="Previous page (←)">
      <i class="fa-solid fa-arrow-left"></i>
    </button>
    <button class="nav-btn icon-btn" id="nextPageBtn" title="Next page (→)">
      <i class="fa-solid fa-arrow-right"></i>
    </button>
    <div class="toolbar-sep" aria-hidden="true"></div>
    <button class="nav-btn icon-btn" id="fitWidthBtn" title="Fit width">
      <i class="fa-solid fa-up-right-and-down-left-from-center"></i>
    </button>
    <button class="nav-btn icon-btn" id="toggleReaderBtn" title="Full screen reading (F)">
      <i class="fa-solid fa-maximize"></i>
    </button>
    <div class="toolbar-sep" aria-hidden="true"></div>
    <button class="nav-btn icon-btn span-2" id="helpBtn" title="Help & shortcuts">
      <i class="fa-solid fa-question"></i>
    </button>
  </div>

  <div class="main" id="main">
    <div id="pages"></div>
  </div>
</div>

<!-- Reader hint -->
<div class="reader-hint">Full screen reading. ←/→ prev/next page · ↑/↓ scroll · F to exit</div>

<!-- Comment sidebar -->
<aside id="commentSidebar">
  <div class="cs-header">
    <span id="csTitle">Comments</span>
    <button class="nav-btn icon-btn" id="csClose" title="Close">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="cs-thread" id="csThread"></div>
  <div class="cs-input">
    <div class="cs-author-line">
      <span>Commenting as <strong id="csAuthorName">Guest</strong></span>
      <button class="mini-btn" id="csIdentityBtn" title="Edit name or signature"><i class="fa-solid fa-user-pen"></i></button>
    </div>
    <textarea id="csText" placeholder="Write a comment..."></textarea>
    <div class="cs-actions">
      <button class="nav-btn" id="csPost">Post</button>
      <button class="nav-btn" id="csReplyClose">Hide</button>
    </div>
  </div>
</aside>

<!-- Help modal -->
<div id="helpModal" class="help-modal hidden" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
  <div class="help-card">
    <header class="help-header">
      <h2 id="helpTitle">Minimal viewer guide</h2>
      <button id="helpClose" class="mini-btn" title="Close help"><i class="fa-solid fa-xmark"></i></button>
    </header>
    <div class="help-body">
      <p>This viewer keeps PDF markup simple. Open a file, add lightweight notes, and export.</p>
      <h3>Workflow</h3>
      <ul>
        <li><strong>Open</strong> a PDF, then <strong>Save</strong> to download your annotations.</li>
        <li>Set your <strong>name & signature</strong> once; it is stored for reuse.</li>
        <li>Existing PDF text comments load as pins you can continue replying to.</li>
        <li>Add <strong>text</strong>, <strong>comments</strong>, or <strong>signatures</strong> one at a time — click the page after picking a tool.</li>
      </ul>
      <h3>Navigation</h3>
      <ul>
        <li><strong>Arrow keys</strong>: Left/Right change pages, Up/Down scroll.</li>
        <li><strong>Zoom</strong> with +/- buttons. At any zoom other than 100% annotations are hidden to avoid misalignment.</li>
        <li><strong>Fit width</strong> fills the reading column. <strong>F</strong> toggles full-screen reader mode.</li>
      </ul>
      <h3>Tips</h3>
      <ul>
        <li>Use the person icon to change your name or redraw your signature.</li>
        <li>Click outside the comment drawer to collapse it.</li>
        <li>Return to 100% (or Save) to bring annotations back after zooming.</li>
        <li>Signatures show a corner handle — drag it to resize without re-drawing.</li>
      </ul>
    </div>
  </div>
</div>

<!-- Floating text style panel -->
<div id="textStylePanel" class="floating-panel hidden">
  <label>
    Font
    <select id="textFontFamily">
      <option value="Helvetica">Helvetica</option>
      <option value="Times New Roman">Times</option>
      <option value="Courier New">Courier</option>
      <option value="Georgia">Georgia</option>
    </select>
  </label>
  <label>
    Size
    <input id="textFontSize" type="number" min="8" max="96" step="1" value="12"/>
  </label>
  <div class="toggle-row">
    <button id="textBoldBtn" class="mini-btn" title="Bold">B</button>
    <button id="textItalicBtn" class="mini-btn" title="Italic">I</button>
  </div>
  <label class="color-row" title="Text color">
    <span>Color</span>
    <input id="textColor" type="color" value="#000000"/>
  </label>
</div>

<!-- Signature editor -->
<div id="identityModal" class="signature-modal hidden" role="dialog" aria-modal="true">
  <div class="signature-card">
    <header>
      <h2>Your identity</h2>
      <button id="identityClose" class="mini-btn" title="Close"><i class="fa-solid fa-xmark"></i></button>
    </header>
    <label class="identity-field">
      <span>Name</span>
      <input id="identityName" type="text" placeholder="Your name" autocomplete="name" />
    </label>
    <div class="signature-label">Signature</div>
    <canvas id="identitySignatureCanvas" width="400" height="160"></canvas>
    <div class="signature-actions">
      <button id="identityClear" class="nav-btn ghost-btn">Clear signature</button>
      <button id="identitySave" class="nav-btn primary-btn">Save</button>
    </div>
    <p class="signature-hint">Your name is used for comments. Draw or update your signature here.</p>
  </div>
</div>

<script>
/* ----------------- State ----------------- */
let pdfDoc=null, pdfBytes=null, originalPdfBytes=null;
let pages = []; // {num, viewportWidth, viewportHeight, canvas, ctx, layer}
let annotations = {}; // {pageNum: [ {id,type,x,y,content/styles/thread} ]}
let currentTool = 'select'; // select | textOnce | commentOnce | signatureOnce
let currentScale = 1; // CSS units
const ZOOMS = [0.25,0.5,0.75,0.9,1,1.1,1.25,1.5,1.75,2];
let fitWidthMode = false;
let readerMode = false;
let readerPrevScale = 1;
let currentPageIndex = 0; // 0-based for paging in reader
let dpr = window.devicePixelRatio || 1;
const storedSignature = localStorage.getItem('userSignature');
let signatureDataUrl = storedSignature ? storedSignature : null;
let nextAnnoId = 1;
let openCommentTarget = null; // {pageNum, anno}
let userName = localStorage.getItem('userName') || localStorage.getItem('commentAuthor') || '';
let pendingTool = null;
let identityHasInk = !!signatureDataUrl;
let resizeTimer = null;

/* ----------------- DOM ----------------- */
const el = (id)=>document.getElementById(id);
const pagesEl = el('pages');
const mainEl = el('main');
const openBtn = el('openBtn');
const fileInput = el('file');
const saveBtn = el('saveBtn');
const identityBtn = el('identityBtn');
const textTool = el('textTool');
const commentTool = el('commentTool');
const signatureTool = el('signatureTool');
const zoomOutBtn = el('zoomOutBtn');
const zoomInBtn = el('zoomInBtn');
const fitWidthBtn = el('fitWidthBtn');
const toggleReaderBtn= el('toggleReaderBtn');
const prevPageBtn = el('prevPageBtn');
const nextPageBtn = el('nextPageBtn');
const pageInfo = el('pageInfo');
const helpBtn = el('helpBtn');
const textStylePanel = el('textStylePanel');
const textFontFamily = el('textFontFamily');
const textFontSize = el('textFontSize');
const textBoldBtn = el('textBoldBtn');
const textItalicBtn = el('textItalicBtn');
const textColor = el('textColor');
const identityModal = el('identityModal');
const identityName = el('identityName');
const identityClose = el('identityClose');
const identityClear = el('identityClear');
const identitySave = el('identitySave');
const identitySignatureCanvas = el('identitySignatureCanvas');
const identityCtx = identitySignatureCanvas.getContext('2d');
const helpModal = el('helpModal');
const helpClose = el('helpClose');
const cs = {
  panel: el('commentSidebar'),
  title: el('csTitle'),
  thread: el('csThread'),
  authorName: el('csAuthorName'),
  identityBtn: el('csIdentityBtn'),
  text: el('csText'),
  post: el('csPost'),
  close: el('csClose'),
  hide: el('csReplyClose')
};

/* ----------------- Helpers ----------------- */
function clamp(i,min,max){return Math.max(min,Math.min(max,i));}
function snapIndexFromScale(scale){ // nearest index
  let best=0, diff=1e9;
  for(let i=0;i<ZOOMS.length;i++){ const d=Math.abs(ZOOMS[i]-scale); if(d<diff){diff=d;best=i;}}
  return best;
}
function getMainContentSize(){
  const styles = getComputedStyle(mainEl);
  const padX = parseFloat(styles.paddingLeft||'0') + parseFloat(styles.paddingRight||'0');
  const padY = parseFloat(styles.paddingTop||'0') + parseFloat(styles.paddingBottom||'0');
  const width = Math.max(0, mainEl.clientWidth - padX);
  const height = Math.max(0, mainEl.clientHeight - padY);
  return {width, height};
}
async function computeReaderFitScale(){
  if(!pdfDoc) return currentScale;
  const pageCount = pdfDoc.numPages;
  const pageNum = clamp(currentPageIndex+1,1,pageCount);
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale: 1 });
  const {width: availW, height: availH} = getMainContentSize();
  if(availW<=0 || availH<=0) return currentScale;
  const scaleX = availW / viewport.width;
  const scaleY = availH / viewport.height;
  const fitScale = Math.min(scaleX, scaleY);
  return clamp(fitScale, ZOOMS[0], ZOOMS[ZOOMS.length-1]);
}
function setTool(name){
  currentTool = name;
  // visual emphasis (toggle class on icons)
  [textTool,commentTool,signatureTool].forEach(b=>b && b.classList.remove('active'));
  if(name==='textOnce' && textTool) textTool.classList.add('active');
  if(name==='commentOnce' && commentTool) commentTool.classList.add('active');
  if(name==='signatureOnce' && signatureTool) signatureTool.classList.add('active');
}
function updateIdentityDisplay(){
  if(cs.authorName){ cs.authorName.textContent = userName || 'Set name'; }
}
function updateToolbarStates(){
  if(openBtn){ openBtn.classList.toggle('needs-file', !pdfDoc); }
  if(saveBtn){ saveBtn.disabled = !pdfDoc; }
  if(toggleReaderBtn){ toggleReaderBtn.classList.toggle('active', readerMode); }
  if(identityBtn){ identityBtn.title = userName ? `Signed in as ${userName}` : 'Set name & signature'; }
}
function updatePageInfo(){
  const pct = Math.round(currentScale*100);
  const pageCount = pdfDoc? pdfDoc.numPages : 1;
  const pageNum = clamp(currentPageIndex+1,1,pageCount);
  pageInfo.textContent = `${pageNum} / ${pageCount} · ${pct}%`;
}

function updateAnnotationVisibility(){
  const hide = readerMode || Math.abs(currentScale-1) > 0.001;
  document.body.classList.toggle('annotations-hidden', hide);
  const annoButtons = [textTool, commentTool, signatureTool];
  annoButtons.forEach(btn=>{ if(btn){ btn.disabled = hide; if(hide) btn.classList.remove('active'); }});
  if(hide){
    if(currentTool!=='select'){ setTool('select'); }
    hideTextToolbar();
    closeCommentUI();
  }
}
function inchToPx(v){return v*96;}
function toRgb(hex){const r=parseInt(hex.substr(1,2),16)/255,g=parseInt(hex.substr(3,2),16)/255,b=parseInt(hex.substr(5,2),16)/255;return {r,g,b};}
function ensurePageSlot(num){
  let slot = pages[num-1];
  if(slot) return slot;
  slot = { num, canvas: document.createElement('canvas'), ctx: null, layer: document.createElement('div'), vw:0, vh:0 };
  slot.layer.className='layer';
  const wrap = document.createElement('div'); wrap.className='page'; wrap.dataset.page=num;
  wrap.appendChild(slot.canvas); wrap.appendChild(slot.layer);
  pagesEl.appendChild(wrap);
  slot.ctx = slot.canvas.getContext('2d');
  pages[num-1] = slot;
  attachLayerEvents(slot.layer, num);
  return slot;
}
function anchorScrollBefore(){ // returns normalized position of top in document
  const total = pagesEl.scrollHeight - mainEl.clientHeight;
  return total>0 ? mainEl.scrollTop/total : 0;
}
function restoreScroll(pos){
  const total = pagesEl.scrollHeight - mainEl.clientHeight;
  mainEl.scrollTop = pos*total;
}

/* ----------------- Rendering ----------------- */
async function renderPage(num){
  const page = await pdfDoc.getPage(num);
  const viewport = page.getViewport({ scale: currentScale });
  const slot = ensurePageSlot(num);
  slot.vw = viewport.width; slot.vh = viewport.height;
  // CSS size
  slot.canvas.style.width = `${viewport.width}px`;
  slot.canvas.style.height = `${viewport.height}px`;
  // device pixels
  const realW = Math.floor(viewport.width * dpr);
  const realH = Math.floor(viewport.height * dpr);
  if (slot.canvas.width !== realW || slot.canvas.height !== realH){
    slot.canvas.width = realW; slot.canvas.height = realH;
  }
  slot.layer.style.width = `${viewport.width}px`;
  slot.layer.style.height = `${viewport.height}px`;

  const t = [dpr,0,0,dpr,0,0];
  await page.render({ canvasContext: slot.ctx, viewport, transform: t }).promise;
}
async function renderAll(){
  if(!pdfDoc) return;
  const keep = readerMode ? 0 : anchorScrollBefore();
  pagesEl.innerHTML=''; pages.length=0;
  for(let i=1;i<=pdfDoc.numPages;i++) await renderPage(i);
  if(!readerMode) restoreScroll(keep);
  rehydrateAnnotations();
  updatePageInfo();
  applyReaderLayout();
  updateAnnotationVisibility();
}

function rehydrateAnnotations(){
  if(!annotations) return;
  for(const key of Object.keys(annotations)){
    const pageNum = parseInt(key,10);
    if(Number.isNaN(pageNum)) continue;
    const list = annotations[key];
    if(!Array.isArray(list) || !list.length) continue;
    const slot = pages[pageNum-1];
    if(!slot || !slot.layer) continue;
    for(const anno of list){
      addAnnotationElement(slot.layer, pageNum, anno, {addToState:false});
    }
  }
}

function parsePdfCommentThread(contents, fallbackAuthor){
  const normalized = (contents || '').replace(/\r\n/g,'\n').trim();
  if(!normalized){
    return fallbackAuthor ? [{ author: fallbackAuthor, text: '', time: '' }] : [];
  }
  const blocks = normalized.split(/\n\s*\n/);
  const thread = [];
  for(const block of blocks){
    const lines = block.split('\n');
    if(!lines.length) continue;
    const header = lines.shift().trim();
    let author = fallbackAuthor || 'Comment';
    let time = '';
    let text = lines.join('\n').trim();
    const match = header.match(/^(.*?)\s*\(([^)]*)\):\s*$/);
    if(match){
      author = match[1].trim() || author;
      time = match[2].trim();
    }else{
      text = [header, text].filter(Boolean).join('\n').trim();
    }
    thread.push({ author, text, time });
  }
  if(!thread.length){
    thread.push({ author: fallbackAuthor || 'Comment', text: normalized, time: '' });
  }
  return thread;
}

async function importPdfComments(){
  if(!pdfDoc) return;
  const pageCount = pdfDoc.numPages;
  let maxId = nextAnnoId;
  for(let pageNum=1; pageNum<=pageCount; pageNum++){
    const page = await pdfDoc.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1 });
    const pageHeight = viewport.height;
    const annots = await page.getAnnotations({ intent: 'display' });
    if(!annots || !annots.length) continue;
    for(const annot of annots){
      const subtype = annot.subtype || annot.subType || annot.annotationType;
      if(subtype!=='Text') continue;
      if(!Array.isArray(annot.rect) || annot.rect.length<4) continue;
      const rectRaw = annot.rect.map(v=>typeof v==='number'?v:parseFloat(v));
      if(rectRaw.some(v=>Number.isNaN(v))) continue;
      const left = Math.min(rectRaw[0], rectRaw[2]);
      const top = Math.max(rectRaw[1], rectRaw[3]);
      const x = left;
      const y = pageHeight - top;
      const thread = parsePdfCommentThread(annot.contents || annot.content || '', annot.title || annot.t);
      if(!thread.length) continue;
      const anno = { id: maxId++, type:'comment', x, y, thread };
      if(!annotations[pageNum]) annotations[pageNum]=[];
      annotations[pageNum].push(anno);
    }
  }
  nextAnnoId = maxId;
}

/* ----------------- Events: open/save ----------------- */
async function loadPdfBytesArray(byteSource){
  const data = byteSource instanceof Uint8Array ? Uint8Array.from(byteSource) : new Uint8Array(byteSource);
  pdfBytes = Uint8Array.from(data);
  originalPdfBytes = Uint8Array.from(data);
  const loading = pdfjsLib.getDocument({ data: pdfBytes });
  pdfDoc = await loading.promise;
  annotations = {};
  nextAnnoId = 1;
  await importPdfComments();
  currentScale = 1; fitWidthMode=false; readerMode=false; readerPrevScale = 1; currentPageIndex=0;
  await renderAll();
  setTool('select');
  hideTextToolbar();
  closeCommentUI();
  updateToolbarStates();
  updateAnnotationVisibility();
}

openBtn.onclick = ()=>fileInput.click();
fileInput.onchange = async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const buf = await f.arrayBuffer();
  await loadPdfBytesArray(new Uint8Array(buf));
  e.target.value='';
};
saveBtn.onclick = async ()=>{
  if(!pdfBytes || !pdfDoc){alert('Open a PDF first.');return;}
  try{
    const baseBytes = (originalPdfBytes && originalPdfBytes.length) ? originalPdfBytes : pdfBytes;
    const sourceBytes = baseBytes instanceof Uint8Array ? Uint8Array.from(baseBytes) : new Uint8Array(baseBytes);
    if(!sourceBytes.length){ throw new Error('No PDF data available'); }
    const doc = await PDFLib.PDFDocument.load(sourceBytes);
    const helv = await doc.embedFont(PDFLib.StandardFonts.Helvetica);
    const helvB = await doc.embedFont(PDFLib.StandardFonts.HelveticaBold);
    const times = await doc.embedFont(PDFLib.StandardFonts.TimesRoman);
    const cour = await doc.embedFont(PDFLib.StandardFonts.Courier);

    const N=PDFLib.PDFName, S=PDFLib.PDFString, Num=PDFLib.PDFNumber, PDFArray=PDFLib.PDFArray, PDFRef=PDFLib.PDFRef;
    const addTextAnnot = (page, x,y,w,h, contents, author)=>{
      const rect = doc.context.obj([Num.of(x),Num.of(y),Num.of(x+w),Num.of(y+h)]);
      const annot = doc.context.obj({
        Type:N.of('Annot'), Subtype:N.of('Text'), Rect:rect,
        Contents:S.of(contents||''), T:S.of(author||''),
        C: doc.context.obj([Num.of(1),Num.of(0.85),Num.of(0.35)]),
        Name:N.of('Comment'), F: Num.of(4)
      });
      const ref = doc.context.register(annot);
      const arr = page.node.get(N.of('Annots'));
      if(arr) arr.push(ref); else page.node.set(N.of('Annots'), doc.context.obj([ref]));
    };

    const pagesLib = doc.getPages();
    pagesLib.forEach((page)=>{
      const annotsObj = page.node.get(N.of('Annots'));
      if(!annotsObj) return;
      let arr = annotsObj;
      if(arr instanceof PDFRef){
        arr = doc.context.lookup(arr);
      }
      if(!(arr instanceof PDFArray)) return;
      const kept = [];
      for(let idx=0; idx<arr.size; idx++){
        const ref = arr.get(idx);
        const annot = doc.context.lookup(ref);
        const subtype = annot?.get?.(N.of('Subtype'));
        const keep = !(subtype && subtype.toString && subtype.toString() === '/Text');
        if(keep) kept.push(ref);
      }
      if(kept.length){
        const newArr = PDFArray.withContext(doc.context);
        kept.forEach(ref=>newArr.push(ref));
        page.node.set(N.of('Annots'), newArr);
      }else{
        page.node.delete(N.of('Annots'));
      }
    });
    for(const key in annotations){
      const list = annotations[key]; if(!list || !list.length) continue;
      const pIndex = parseInt(key,10)-1;
      const page = pagesLib[pIndex]; const {height:ph} = page.getSize();
      for(const a of list){
        if(a.type==='text' && a.content && a.content.trim()){
          let font = helv;
          if(a.styles?.fontFamily?.includes('Times')) font=times;
          else if(a.styles?.fontFamily?.includes('Courier')) font=cour;
          else if(a.styles?.fontWeight==='bold') font=helvB;
          const size = parseInt(a.styles?.fontSize||'12',10);
          const col = toRgb(a.styles?.color||'#000000');
          page.drawText(a.content, { x:a.x, y: ph - a.y - size, size, font, color: PDFLib.rgb(col.r,col.g,col.b)});
        } else if(a.type==='signature' && a.dataUrl){
          const img = await doc.embedPng(a.dataUrl);
          const w = a.w || 200, h = a.h || 80;
          page.drawImage(img, { x:a.x, y: ph - a.y - h, width:w, height:h });
        } else if(a.type==='comment' && (a.thread?.length||0)>0){
          // combine thread into a popup string
          const msg = a.thread.map(c => `${c.author||'User'} (${c.time||''}):\n${c.text||''}`).join('\n\n');
          addTextAnnot(page, a.x, ph - a.y - 24, 24, 24, msg, a.thread[0]?.author || '');
        }
      }
    }
    const out = await doc.save();
    const outBytes = out instanceof Uint8Array ? out : new Uint8Array(out);
    pdfBytes = Uint8Array.from(outBytes);
    originalPdfBytes = Uint8Array.from(outBytes);
    const blob = new Blob([pdfBytes], {type:'application/pdf'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='annotated.pdf'; a.click(); URL.revokeObjectURL(url);
    if(Math.abs(currentScale-1) > 0.001){
      setScale(1);
    }else{
      updateAnnotationVisibility();
    }
  }catch(err){
    alert('Save failed: '+err.message);
    console.error(err);
  }
};

/* ----------------- Tools ----------------- */
if(identityBtn){
  identityBtn.onclick = ()=>{
    pendingTool = null;
    openIdentityModal();
  };
}
if(textTool){
  textTool.onclick = ()=>setTool('textOnce');
}
if(commentTool){
  commentTool.onclick = ()=>{
    if(!userName){
      pendingTool = 'commentOnce';
      openIdentityModal();
    }else{
      setTool('commentOnce');
    }
  };
}

function openIdentityModal(){
  identityModal.classList.remove('hidden');
  setTool('select');
  const existing = signatureDataUrl;
  identityHasInk = !!existing;
  identityCtx.clearRect(0,0,identitySignatureCanvas.width, identitySignatureCanvas.height);
  identityName.value = userName;
  if(existing){
    const img = new Image();
    img.onload = ()=>{
      identityCtx.clearRect(0,0,identitySignatureCanvas.width,identitySignatureCanvas.height);
      identityCtx.drawImage(img,0,0,identitySignatureCanvas.width,identitySignatureCanvas.height);
      identityHasInk = true;
    };
    img.src = existing;
  }
  requestAnimationFrame(()=> identityName.focus());
}
function closeIdentityModal(){
  identityModal.classList.add('hidden');
  pendingTool = null;
  setTool('select');
}

function openHelpModal(){
  if(helpModal){
    helpModal.classList.remove('hidden');
    requestAnimationFrame(()=>{
      if(helpClose){ helpClose.focus(); }
    });
  }
}

function closeHelpModal(){
  if(helpModal){ helpModal.classList.add('hidden'); }
}

if(helpBtn){ helpBtn.onclick = ()=>openHelpModal(); }
if(helpClose){ helpClose.onclick = ()=>closeHelpModal(); }
if(helpModal){
  helpModal.addEventListener('click',(e)=>{ if(e.target===helpModal) closeHelpModal(); });
}

if(signatureTool){
  signatureTool.onclick = ()=>{
    if(!signatureDataUrl){
      pendingTool = 'signatureOnce';
      openIdentityModal();
    }else{
      setTool('signatureOnce');
    }
  };
}

/* Layer click for placing one-shot items */
function attachLayerEvents(layer, pageNum){
  layer.addEventListener('click', (e)=>{
    if(e.target!==layer) return;
    const rect = layer.getBoundingClientRect();
    const x = e.clientX - rect.left; const y = e.clientY - rect.top;
    if(currentTool==='textOnce'){
      const anno = { id: nextAnnoId++, type:'text', x, y, content:'', styles:{fontFamily:'Helvetica',fontSize:'12',fontWeight:'normal',fontStyle:'normal',color:'#000000'} };
      addAnnotationElement(layer, pageNum, anno, {addToState:true, focus:true});
      setTool('select'); // one-shot
    } else if(currentTool==='commentOnce'){
      const anno = { id: nextAnnoId++, type:'comment', x, y, thread:[] };
      addAnnotationElement(layer, pageNum, anno, {addToState:true});
      openCommentUI(pageNum, anno);
      setTool('select');
    } else if(currentTool==='signatureOnce' && signatureDataUrl){
      const anno = { id: nextAnnoId++, type:'signature', x, y, w:200, h:80, dataUrl: signatureDataUrl };
      addAnnotationElement(layer, pageNum, anno, {addToState:true});
      setTool('select');
    }
  });
}

/* Create DOM for annotation & register */
function addAnnotationElement(layer, pageNum, anno, opts){
  const options = typeof opts==='boolean' ? {addToState: opts} : (opts || {});
  const { addToState=false, focus=false } = options;
  if(addToState){
    if(!annotations[pageNum]) annotations[pageNum]=[];
    annotations[pageNum].push(anno);
  }
  if(anno.type==='text'){
    const div = document.createElement('div'); div.className='text-anno'; div.contentEditable=true; div.dataset.id=anno.id;
    div.style.left = anno.x+'px'; div.style.top = anno.y+'px'; div.style.minWidth='120px'; div.style.minHeight='24px';
    div.style.fontFamily = anno.styles.fontFamily; div.style.fontSize = (parseInt(anno.styles.fontSize,10)||12)+'px';
    div.style.fontWeight = anno.styles.fontWeight; div.style.fontStyle=anno.styles.fontStyle; div.style.color = anno.styles.color||'#000';
    div.placeholder = 'Type…';
    div.textContent = anno.content || '';
    div.addEventListener('input',()=>{
      anno.content = div.textContent;
      if(document.activeElement===div){
        showTextToolbar(div, anno);
        positionTextToolbar(div);
      }
    });
    div.addEventListener('focus',()=>showTextToolbar(div, anno));
    div.addEventListener('click',()=>showTextToolbar(div, anno));
    makeDraggable(div, anno, layer);
    layer.appendChild(div);
    if(focus){
      div.focus();
      showTextToolbar(div, anno);
    }
  } else if(anno.type==='comment'){
    const pin = document.createElement('div'); pin.className='comment-pin'; pin.textContent='C'; pin.dataset.id=anno.id;
    pin.style.left = (anno.x-11)+'px'; pin.style.top=(anno.y-11)+'px';
    pin.onclick = (ev)=>{ ev.stopPropagation(); openCommentUI(pageNum, anno); };
    makeDraggable(pin, anno, layer, true);
    layer.appendChild(pin);
  } else if(anno.type==='signature'){
    const box = document.createElement('div'); box.className='sig-anno'; box.dataset.id=anno.id;
    box.style.left=anno.x+'px'; box.style.top=anno.y+'px';
    const width = parseFloat(anno.w)||200; const height = parseFloat(anno.h)||80;
    anno.w = width; anno.h = height;
    box.style.width=width+'px'; box.style.height=height+'px';
    const img = document.createElement('img'); img.src=anno.dataUrl; img.draggable=false; box.appendChild(img);
    const handle = document.createElement('div'); handle.className='resize-handle'; box.appendChild(handle);
    box.addEventListener('mousedown',()=>{
      document.querySelectorAll('.sig-anno').forEach(el=>{ if(el!==box) el.classList.remove('selected'); });
      box.classList.add('selected');
    });
    makeDraggable(box, anno, layer);
    makeResizable(box, handle, anno);
    layer.appendChild(box);
  }
}

/* Dragging */
function makeDraggable(el, anno, layer, isPin=false){
  let dragging=false,sx=0,sy=0, origL=0,origT=0;
  el.addEventListener('mousedown',(e)=>{
    const isText = el.classList.contains('text-anno');
    const isSignature = el.classList.contains('sig-anno');
    if(isText && e.target!==el) return;
    if(!isText && !isSignature && !isPin && e.target!==el) return;
    dragging=true; sx=e.clientX; sy=e.clientY; origL=parseFloat(el.style.left); origT=parseFloat(el.style.top);
    e.preventDefault();
    if(isText) hideTextToolbar();
  });
  window.addEventListener('mousemove',(e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; el.style.left=(origL+dx)+'px'; el.style.top=(origT+dy)+'px'; if(isPin){ anno.x=parseFloat(el.style.left)+11; anno.y=parseFloat(el.style.top)+11; } else { anno.x=parseFloat(el.style.left); anno.y=parseFloat(el.style.top);} if(el.classList.contains('text-anno')) positionTextToolbar(el); });
  window.addEventListener('mouseup',()=>dragging=false);
}

function makeResizable(el, handle, anno){
  if(!handle) return;
  const MIN_W = 60;
  const MIN_H = 24;
  let resizing=false,startX=0,startY=0,startW=0,startH=0;
  handle.addEventListener('mousedown',(e)=>{
    e.preventDefault();
    e.stopPropagation();
    resizing=true;
    startX=e.clientX; startY=e.clientY;
    startW=parseFloat(el.style.width)||anno.w||200;
    startH=parseFloat(el.style.height)||anno.h||80;
    el.classList.add('selected');
  });
  window.addEventListener('mousemove',(e)=>{
    if(!resizing) return;
    const dw=e.clientX-startX;
    const dh=e.clientY-startY;
    const newW=Math.max(MIN_W, startW+dw);
    const newH=Math.max(MIN_H, startH+dh);
    el.style.width=`${newW}px`;
    el.style.height=`${newH}px`;
    anno.w=newW;
    anno.h=newH;
  });
  window.addEventListener('mouseup',()=>{
    if(resizing){ resizing=false; el.classList.remove('selected'); }
  });
}

document.addEventListener('mousedown',(e)=>{
  if(e.target.closest && e.target.closest('.sig-anno')) return;
  document.querySelectorAll('.sig-anno.selected').forEach(el=>el.classList.remove('selected'));
});

/* ----------------- Comment UI (right sidebar) ----------------- */
function openCommentUI(pageNum, anno){
  openCommentTarget = {pageNum, anno};
  cs.panel.classList.add('open');
  cs.thread.innerHTML='';
  cs.title.textContent = `Comments (p.${pageNum})`;
  updateIdentityDisplay();
  if(anno.thread && anno.thread.length){
    for(const c of anno.thread){
      const div = document.createElement('div'); div.className='cs-item';
      div.innerHTML = `<div class="cs-author">${c.author||'User'}</div>
        <div class="cs-text">${(c.text||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
        <div class="cs-time">${c.time||''}</div>`;
      cs.thread.appendChild(div);
    }
    cs.thread.scrollTop = cs.thread.scrollHeight;
  }
  cs.text.focus();
}
function closeCommentUI(){
  cs.panel.classList.remove('open');
  openCommentTarget = null;
}
cs.post.onclick = ()=>{
  if(!openCommentTarget) return;
  if(!userName){
    pendingTool = null;
    openIdentityModal();
    return;
  }
  const text = cs.text.value.trim(); if(!text) return;
  const c = {author: userName, text, time: new Date().toLocaleString()};
  const {pageNum, anno} = openCommentTarget;
  if(!anno.thread) anno.thread=[]; anno.thread.push(c);
  cs.text.value='';
  openCommentUI(pageNum, anno);
};
cs.close.onclick = closeCommentUI;
cs.hide.onclick = closeCommentUI;
if(cs.identityBtn){
  cs.identityBtn.onclick = ()=>{
    pendingTool = null;
    openIdentityModal();
  };
}

/* Close sidebar when clicking outside */
document.addEventListener('click',(e)=>{
  if(!cs.panel.classList.contains('open')) return;
  if(cs.panel.contains(e.target)) return;
  if(e.target.closest && e.target.closest('.comment-pin')) return;
  closeCommentUI();
}, true);

/* ----------------- Zoom & layout ----------------- */
function setScale(scale){
  currentScale = scale; fitWidthMode=false;
  updateAnnotationVisibility();
  renderAll();
}
zoomInBtn.onclick = ()=>{
  const idx = snapIndexFromScale(currentScale);
  const next = clamp(idx+1,0,ZOOMS.length-1);
  setScale(ZOOMS[next]);
};
zoomOutBtn.onclick = ()=>{
  const idx = snapIndexFromScale(currentScale);
  const prev = clamp(idx-1,0,ZOOMS.length-1);
  setScale(ZOOMS[prev]);
};
fitWidthBtn.onclick = ()=>{
  if(!pdfDoc) return;
  // fit first page width
  pdfDoc.getPage(1).then(page=>{
    const viewport = page.getViewport({scale:1});
    const {width: availWidth} = getMainContentSize();
    const target = availWidth>0 ? availWidth : mainEl.clientWidth;
    let scale = Math.max(ZOOMS[0], Math.min(ZOOMS[ZOOMS.length-1], target / viewport.width));
    currentScale = scale; fitWidthMode=true;
    updateAnnotationVisibility();
    renderAll();
  });
};

/* ----------------- Reader Mode & paging ----------------- */
function applyReaderLayout(){
  document.body.classList.toggle('reader', readerMode);
  // In reader mode, show only the current page, hide others
  const pc = pdfDoc ? pdfDoc.numPages : 0;
  pagesEl.querySelectorAll('.page').forEach((wrap)=>{ wrap.style.display='none'; wrap.style.marginRight=''; });
  if(!pdfDoc) return;
  if(!readerMode){
    // show all
    pagesEl.querySelectorAll('.page').forEach((wrap)=>{ wrap.style.display='block'; wrap.style.marginRight=''; });
    return;
  }
  const p = clamp(currentPageIndex+1,1,pc);
  const wrap = pagesEl.querySelector(`.page[data-page="${p}"]`);
  if(wrap){ wrap.style.display='block'; }
}
async function toggleReader(){
  if(!pdfDoc){ return; }
  const entering = !readerMode;
  if(entering){
    readerPrevScale = currentScale;
    readerMode = true;
    fitWidthMode = false;
    const fitScale = await computeReaderFitScale();
    currentScale = fitScale;
    await renderAll();
    mainEl.scrollTop = 0;
    mainEl.scrollLeft = 0;
    closeCommentUI();
    if(document.fullscreenElement==null){
      const req = document.documentElement.requestFullscreen;
      if(typeof req==='function'){
        Promise.resolve(req.call(document.documentElement)).catch(()=>{});
      }
    }
  }else{
    readerMode = false;
    fitWidthMode = false;
    currentScale = readerPrevScale || currentScale;
    await renderAll();
    mainEl.scrollTop = 0;
    mainEl.scrollLeft = 0;
    if(document.fullscreenElement && typeof document.exitFullscreen==='function'){
      document.exitFullscreen().catch?.(()=>{});
    }
  }
  updatePageInfo();
  updateToolbarStates();
  updateAnnotationVisibility();
}
if(toggleReaderBtn){ toggleReaderBtn.addEventListener('click',()=>{ toggleReader(); }); }

/* Page navigation */
function goToPage(delta){
  if(!pdfDoc) return;
  const pageCount = pdfDoc.numPages;
  currentPageIndex = clamp(currentPageIndex+delta,0,pageCount-1);
  if(readerMode){
    applyReaderLayout();
    mainEl.scrollTop = 0;
    mainEl.scrollLeft = 0;
  }else{
    const target = pagesEl.querySelector(`.page[data-page="${currentPageIndex+1}"]`);
    if(target){
      target.scrollIntoView({behavior:'smooth',block:'start'});
    }
  }
  updatePageInfo();
}
if (prevPageBtn) prevPageBtn.onclick = ()=>goToPage(-1);
if (nextPageBtn) nextPageBtn.onclick = ()=>goToPage(1);

/* ----------------- Keyboard ----------------- */
document.addEventListener('keydown',(e)=>{
  const targetTag = e.target.tagName;
  const editing = e.target.isContentEditable || targetTag==='INPUT' || targetTag==='TEXTAREA' || targetTag==='SELECT';
  if(!editing && (e.key==='f' || e.key==='F')){ e.preventDefault(); toggleReader(); return; }
  if(!editing && e.key==='+'){ zoomInBtn.click(); }
  if(!editing && e.key==='-'){ zoomOutBtn.click(); }
  if((e.key==='ArrowUp' || e.key==='ArrowDown') && !editing){
    e.preventDefault();
    const delta = e.key==='ArrowUp' ? -120 : 120;
    mainEl.scrollBy({top: delta, behavior:'smooth'});
    return;
  }
  if(e.key==='Escape'){
    setTool('select');
    hideTextToolbar();
    if(identityModal && !identityModal.classList.contains('hidden')) closeIdentityModal();
    if(helpModal && !helpModal.classList.contains('hidden')) closeHelpModal();
  }
  if(readerMode){
    if(!editing && e.key==='ArrowLeft'){ e.preventDefault(); goToPage(-1); }
    if(!editing && e.key==='ArrowRight'){ e.preventDefault(); goToPage(1); }
  } else {
    if(!editing && (e.key==='t' || e.key==='T') && textTool){ textTool.click(); }
    if(!editing && (e.key==='m' || e.key==='M') && commentTool){ commentTool.click(); }
    if(!editing && (e.key==='s' || e.key==='S') && signatureTool){ signatureTool.click(); }
    if(!editing && e.key==='ArrowLeft'){ e.preventDefault(); goToPage(-1); }
    if(!editing && e.key==='ArrowRight'){ e.preventDefault(); goToPage(1); }
  }
});

/* ----------------- Text toolbar logic ----------------- */
let textToolbarTarget = null;
let textToolbarAnno = null;

function positionTextToolbar(el){
  if(!textToolbarTarget) return;
  const rect = el.getBoundingClientRect();
  const panelRect = textStylePanel.getBoundingClientRect();
  const panelHeight = panelRect.height || textStylePanel.offsetHeight || 0;
  const panelWidth = panelRect.width || textStylePanel.offsetWidth || 0;
  let top = window.scrollY + rect.top - panelHeight - 8;
  let left = window.scrollX + rect.left;
  if(top < 8){
    top = window.scrollY + rect.bottom + 8;
  }
  const maxLeft = window.scrollX + document.documentElement.clientWidth - panelWidth - 8;
  if(left > maxLeft){
    left = maxLeft;
  }
  textStylePanel.style.top = Math.max(8, top)+'px';
  textStylePanel.style.left = Math.max(8, left)+'px';
}

function showTextToolbar(el, anno){
  textToolbarTarget = el;
  textToolbarAnno = anno;
  textFontFamily.value = anno.styles.fontFamily || 'Helvetica';
  textFontSize.value = parseInt(anno.styles.fontSize,10)||12;
  textBoldBtn.classList.toggle('active', anno.styles.fontWeight==='bold');
  textItalicBtn.classList.toggle('active', anno.styles.fontStyle==='italic');
  textColor.value = anno.styles.color || '#000000';
  textStylePanel.classList.remove('hidden');
  positionTextToolbar(el);
}

function hideTextToolbar(){
  textToolbarTarget = null;
  textToolbarAnno = null;
  textStylePanel.classList.add('hidden');
}

textFontFamily.addEventListener('change',()=>{
  if(!textToolbarTarget||!textToolbarAnno) return;
  textToolbarAnno.styles.fontFamily = textFontFamily.value;
  textToolbarTarget.style.fontFamily = textFontFamily.value;
});

textFontSize.addEventListener('change',()=>{
  if(!textToolbarTarget||!textToolbarAnno) return;
  const size = clamp(parseInt(textFontSize.value,10)||12,8,96);
  textToolbarAnno.styles.fontSize = String(size);
  textToolbarTarget.style.fontSize = size+'px';
});

textBoldBtn.addEventListener('click',(e)=>{
  e.preventDefault();
  if(!textToolbarTarget||!textToolbarAnno) return;
  const isBold = textToolbarAnno.styles.fontWeight==='bold';
  textToolbarAnno.styles.fontWeight = isBold?'normal':'bold';
  textToolbarTarget.style.fontWeight = textToolbarAnno.styles.fontWeight;
  textBoldBtn.classList.toggle('active', !isBold);
});

textItalicBtn.addEventListener('click',(e)=>{
  e.preventDefault();
  if(!textToolbarTarget||!textToolbarAnno) return;
  const isItalic = textToolbarAnno.styles.fontStyle==='italic';
  textToolbarAnno.styles.fontStyle = isItalic?'normal':'italic';
  textToolbarTarget.style.fontStyle = textToolbarAnno.styles.fontStyle;
  textItalicBtn.classList.toggle('active', !isItalic);
});

textColor.addEventListener('input',()=>{
  if(!textToolbarTarget||!textToolbarAnno) return;
  textToolbarAnno.styles.color = textColor.value;
  textToolbarTarget.style.color = textColor.value;
});

document.addEventListener('click',(e)=>{
  if(textStylePanel.contains(e.target) || (textToolbarTarget && textToolbarTarget.contains(e.target))){
    return;
  }
  hideTextToolbar();
});

window.addEventListener('scroll',()=>{
  if(textToolbarTarget) positionTextToolbar(textToolbarTarget);
});
if(mainEl){
  mainEl.addEventListener('scroll',()=>{
    if(textToolbarTarget) positionTextToolbar(textToolbarTarget);
  });
}

window.addEventListener('resize',()=>{
  dpr = window.devicePixelRatio || 1;
  if(textToolbarTarget) positionTextToolbar(textToolbarTarget);
  if(resizeTimer) clearTimeout(resizeTimer);
  resizeTimer = setTimeout(async ()=>{
    if(readerMode && pdfDoc){
      const scale = await computeReaderFitScale();
      currentScale = scale;
      await renderAll();
      mainEl.scrollTop = 0;
      updatePageInfo();
      updateToolbarStates();
    }
  }, 120);
});

/* ----------------- Signature modal ----------------- */
identityCtx.lineCap='round';
identityCtx.lineJoin='round';
identityCtx.lineWidth=2;
identityCtx.strokeStyle='#111';
let identityDrawing=false;

identitySignatureCanvas.addEventListener('pointerdown',(e)=>{
  e.preventDefault();
  identityDrawing=true;
  identitySignatureCanvas.setPointerCapture(e.pointerId);
  identityCtx.beginPath();
  identityCtx.moveTo(e.offsetX,e.offsetY);
  identityHasInk = true;
});
identitySignatureCanvas.addEventListener('pointermove',(e)=>{
  if(identityDrawing) e.preventDefault();
  if(!identityDrawing) return;
  identityCtx.lineTo(e.offsetX,e.offsetY);
  identityCtx.stroke();
});
['pointerup','pointerleave','pointercancel'].forEach(ev=>identitySignatureCanvas.addEventListener(ev,(e)=>{
  if(ev==='pointerup' && identitySignatureCanvas.hasPointerCapture(e.pointerId)) identitySignatureCanvas.releasePointerCapture(e.pointerId);
  identityDrawing=false;
}));

identityClear.onclick = ()=>{
  identityCtx.clearRect(0,0,identitySignatureCanvas.width, identitySignatureCanvas.height);
  identityHasInk=false;
};

identityClose.onclick = ()=>{
  closeIdentityModal();
};

identitySave.onclick = ()=>{
  const name = identityName.value.trim();
  if(!name){
    identityName.focus();
    return;
  }
  userName = name;
  localStorage.setItem('userName', userName);
  localStorage.removeItem('commentAuthor');
  signatureDataUrl = identityHasInk ? identitySignatureCanvas.toDataURL('image/png') : null;
  if(signatureDataUrl){
    localStorage.setItem('userSignature', signatureDataUrl);
  }else{
    localStorage.removeItem('userSignature');
  }
  updateIdentityDisplay();
  updateToolbarStates();
  identityModal.classList.add('hidden');
  const nextTool = pendingTool;
  pendingTool = null;
  if(nextTool){
    if(nextTool==='signatureOnce' && !signatureDataUrl){
      setTool('select');
    }else{
      setTool(nextTool);
    }
  }
};

identityModal.addEventListener('click',(e)=>{
  if(e.target===identityModal) closeIdentityModal();
});

// default tool state highlight
setTool('select');
updateIdentityDisplay();
updateToolbarStates();
updateAnnotationVisibility();

/* ----------------- Load via ?src= ----------------- */
(function(){
  const u = new URL(location.href);
  const src = u.searchParams.get('src');
  if(!src) return;
  fetch(src).then(r=>r.arrayBuffer()).then(async(buf)=>{
    await loadPdfBytesArray(new Uint8Array(buf));
  }).catch(console.error);
})();

</script>
</body>
</html>
