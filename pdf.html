
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lightweight PDF Viewer + Annotator</title>
<!-- pdf.js & pdf-lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
  const pdfjsLib = window['pdfjs-dist/build/pdf']; // v3 UMD global
  // (With the worker <script> present, you don’t have to set workerSrc.)
</script>

<style>
/* ====== Copy of your Modern Editor header/button look (stacked left) ====== */
:root{
  --font-serif:'Georgia','Times New Roman',serif;
  --font-sans:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  --bg-color:#fffff8;
  --text-color:#1a1a1a;
  --border-color:#d4d4d4;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font-serif);background:var(--bg-color);color:var(--text-color);min-height:100vh;overflow:hidden}
/* Left header column */
.header{
  position:fixed;top:2rem;left:0;z-index:50;padding:16px;display:grid;grid-template-columns:repeat(2,52px);gap:8px 10px;width:auto;justify-items:center;
}
.hamburger-btn,.icon-btn,.nav-btn{
  background:rgba(255,255,255,0.9);
  border:1px solid var(--border-color);
  cursor:pointer;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1);
  transition:all .2s;width:44px;height:44px;display:flex;align-items:center;justify-content:center;line-height:1;padding:6px;font-size:1.5rem;
}
.hamburger-btn:hover,.icon-btn:hover,.nav-btn:hover:not(:disabled){background:#fff;box-shadow:0 4px 8px rgba(0,0,0,.15)}
.nav-btn.active{background:#2563eb;color:#fff;box-shadow:0 4px 8px rgba(37,99,235,.35);}
.icon-btn svg{stroke:currentColor}
.nav-btn:disabled{opacity:.5;cursor:not-allowed}
/* Tiny info pill */
.nav-info{background:rgba(255,255,255,.9);border:1px solid var(--border-color);border-radius:4px;padding:4px 8px;text-align:center;font-size:.85rem;font-family:var(--font-sans);color:#666;font-weight:500}

/* ====== Viewer area ====== */
.app{display:flex;height:100vh;width:100vw}
.main{flex:1;overflow:auto;padding:24px 24px 48px 84px; /* left pad for toolbar */}
#pages{position:relative;display:flex;flex-direction:column;align-items:center;gap:16px}
.page{position:relative;box-shadow:0 2px 8px rgba(0,0,0,.1);background:#fff}
.page canvas{display:block;background:#fff}
.layer{position:absolute;inset:0;pointer-events:auto}
.reader .layer{display:none} /* hide annotation layer in reader */

/* Annotation elements: transparent, borderless by default */
.text-anno,.sig-anno,.comment-pin{position:absolute;pointer-events:auto;cursor:move}
.text-anno{background:transparent;border:none;min-width:120px;min-height:24px;outline:none;color:#000}
.text-anno::placeholder{color:#999}
.text-anno:focus,.text-anno.selected,.sig-anno.selected,.comment-pin.selected{outline:2px solid #2563eb;outline-offset:1px;border-radius:4px}
.sig-anno{background:transparent;border:none}
.sig-anno img{display:block;width:100%;height:100%;object-fit:contain}
.comment-pin{width:22px;height:22px;border-radius:50%;background:#ffd166;border:1px solid #f4a261;display:flex;align-items:center;justify-content:center;font-weight:700;color:#333}

/* Comment sidebar (opens on right) */
#commentSidebar{position:fixed;top:0;right:-380px;width:360px;height:100vh;background:#fff;border-left:1px solid var(--border-color);box-shadow:-10px 0 30px rgba(0,0,0,.15);transition:right .25s;z-index:60;display:flex;flex-direction:column}
#commentSidebar.open{right:0}
.cs-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border-color);font-family:var(--font-sans)}
.cs-thread{flex:1;overflow:auto;padding:10px 14px}
.cs-item{border-bottom:1px solid #eee;padding:8px 0}
.cs-item:last-child{border-bottom:none}
.cs-author{font-weight:600;color:#2563eb;font-size:.85rem}
.cs-time{font-size:.75rem;color:#666}
.cs-text{white-space:pre-wrap;margin-top:2px}
.cs-input{border-top:1px solid var(--border-color);padding:10px 14px}
.cs-input input,.cs-input textarea{width:100%;border:1px solid #ccc;border-radius:6px;padding:8px;margin-bottom:8px;font-family:inherit;font-size:14px}
.cs-actions{display:flex;gap:8px}
.cs-actions .nav-btn{flex:1;height:36px;width:auto}

/* Reader controls hint (top-right) */
.reader-hint{position:fixed;top:10px;right:12px;z-index:40;background:rgba(255,255,255,.9);border:1px solid var(--border-color);border-radius:6px;padding:6px 10px;font-family:var(--font-sans);font-size:.8rem;color:#444;display:none}
.reader .reader-hint{display:block}

/* Page indicator pill */
#pageInfo{background:rgba(255,255,255,.9);border:1px solid var(--border-color);border-radius:14px;padding:4px 8px;font-size:.75rem;font-family:var(--font-sans);color:#666}
#leftBar #pageInfo{grid-column:span 2;justify-self:stretch;display:flex;align-items:center;justify-content:center;height:44px;}

/* Hidden file input */
#file{display:none}

@media (max-width: 800px){
  .main{padding-left:72px}
  .header{grid-template-columns:repeat(2,46px);}
  .hamburger-btn,.icon-btn,.nav-btn{width:38px;height:38px}
}

.hidden{display:none !important;}
.floating-panel{
  position:fixed;
  z-index:120;
  background:#fff;
  border:1px solid var(--border-color);
  border-radius:8px;
  padding:10px 12px;
  box-shadow:0 12px 28px rgba(0,0,0,.25);
  display:flex;
  gap:10px;
  align-items:center;
  font-family:var(--font-sans);
}
.floating-panel label{display:flex;flex-direction:column;font-size:.75rem;gap:4px;color:#333;min-width:90px}
.floating-panel select,.floating-panel input[type="number"]{border:1px solid #ccc;border-radius:6px;padding:4px 6px;font-size:.85rem;font-family:inherit}
.floating-panel input[type="color"]{width:36px;height:24px;border:none;background:transparent;padding:0}
.toggle-row{display:flex;gap:6px;align-items:center}
.mini-btn{
  width:28px;height:28px;border-radius:6px;border:1px solid var(--border-color);
  background:#f5f5f5;cursor:pointer;font-weight:700;font-family:var(--font-sans);
}
.mini-btn.active{background:#2563eb;color:#fff;border-color:#1d4ed8}
.color-row{display:flex;align-items:center;gap:6px;font-size:.75rem;color:#333}

.signature-modal{
  position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:130;
}
.signature-card{
  background:#fff;padding:20px;border-radius:12px;box-shadow:0 18px 45px rgba(0,0,0,.35);width:min(90vw,460px);display:flex;flex-direction:column;gap:12px;font-family:var(--font-sans);
}
.signature-card header{display:flex;align-items:center;justify-content:space-between}
.signature-card h2{font-size:1.1rem;font-weight:600}
.signature-card canvas{width:100%;height:auto;border:1px solid #d4d4d4;border-radius:8px;background:#fff;cursor:crosshair;touch-action:none}
.signature-actions{display:flex;gap:10px;justify-content:flex-end}
.signature-hint{font-size:.75rem;color:#555;text-align:right}
</style>
</head>
<body>
<div class="app">
  <!-- Left toolbar (icons copied style) -->
  <div class="header" id="leftBar">
    <!-- Open -->
    <button class="nav-btn icon-btn" id="openBtn" title="Open PDF">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
    </button>
    <input id="file" type="file" accept="application/pdf"/>
    <!-- Save -->
    <button class="nav-btn icon-btn" id="saveBtn" title="Save PDF (with comments/text/signatures)" disabled>
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
    </button>


    <button class="nav-btn icon-btn" id="textTool" title="Add text (T – one time)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3"/><path d="M9 20V7"/><path d="M15 20V7"/></svg>
    </button>
    <button class="nav-btn icon-btn" id="commentTool" title="Add comment (M – one time)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>
    </button>
    <button class="nav-btn icon-btn" id="signatureTool" title="Add signature (S – one time)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 17c3-3 6 0 9-3s6 0 9-3"/></svg>
    </button>

    <!-- Zoom out / info / zoom in -->
    <button class="nav-btn icon-btn" id="fitWidthBtn" title="Fit width">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 7h18M3 17h18"/><path d="M8 12h8"/><path d="M4 12l-2-2 2-2"/><path d="M20 12l2-2-2-2"/>
      </svg>
    </button>
    <button class="nav-btn icon-btn" id="toggleReaderBtn" title="Full screen reading (F)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M8 3H3v5M21 8V3h-5M16 21h5v-5M3 16v5h5"/>
      </svg>
    </button>
    <button class="nav-btn icon-btn" id="toggleSpreadBtn" title="One/Two page view">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="8" height="16" rx="1"/><rect x="13" y="4" width="8" height="16" rx="1"/>
      </svg>
    </button>
    <button class="nav-btn icon-btn" id="zoomOutBtn" title="Zoom out (-)">−</button>
    <button class="nav-btn icon-btn" id="zoomInBtn" title="Zoom in (+)">+</button>
    <div id="pageInfo" class="nav-info">1 / 1 · 100%</div>
    <button class="nav-btn icon-btn" id="prevPageBtn" title="Previous page (←)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </button>
    <button class="nav-btn icon-btn" id="nextPageBtn" title="Next page (→)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    </button>
  </div>

  <div class="main" id="main">
    <div id="pages"></div>
  </div>
</div>

<!-- Reader hint -->
<div class="reader-hint">Full screen reading. ←/→ prev/next page · ↑/↓ scroll · F to exit</div>

<!-- Comment sidebar -->
<aside id="commentSidebar">
  <div class="cs-header">
    <span id="csTitle">Comments</span>
    <button class="nav-btn icon-btn" id="csClose" title="Close">×</button>
  </div>
  <div class="cs-thread" id="csThread"></div>
  <div class="cs-input">
    <input id="csAuthor" type="text" placeholder="Your name"/>
    <textarea id="csText" placeholder="Write a comment..."></textarea>
    <div class="cs-actions">
      <button class="nav-btn" id="csPost">Post</button>
      <button class="nav-btn" id="csReplyClose">Hide</button>
    </div>
  </div>
</aside>

<!-- Floating text style panel -->
<div id="textStylePanel" class="floating-panel hidden">
  <label>
    Font
    <select id="textFontFamily">
      <option value="Helvetica">Helvetica</option>
      <option value="Times New Roman">Times</option>
      <option value="Courier New">Courier</option>
      <option value="Georgia">Georgia</option>
    </select>
  </label>
  <label>
    Size
    <input id="textFontSize" type="number" min="8" max="96" step="1" value="12"/>
  </label>
  <div class="toggle-row">
    <button id="textBoldBtn" class="mini-btn" title="Bold">B</button>
    <button id="textItalicBtn" class="mini-btn" title="Italic">I</button>
  </div>
  <label class="color-row" title="Text color">
    <span>Color</span>
    <input id="textColor" type="color" value="#000000"/>
  </label>
</div>

<!-- Signature editor -->
<div id="signatureModal" class="signature-modal hidden" role="dialog" aria-modal="true">
  <div class="signature-card">
    <header>
      <h2>Create signature</h2>
      <button id="signatureClose" class="mini-btn" title="Close">×</button>
    </header>
    <canvas id="signatureCanvas" width="400" height="160"></canvas>
    <div class="signature-actions">
      <button id="signatureClear" class="nav-btn">Clear</button>
      <button id="signatureSave" class="nav-btn">Save</button>
    </div>
    <p class="signature-hint">Tip: right-click the signature button to edit again later.</p>
  </div>
</div>

<script>
/* ----------------- State ----------------- */
let pdfDoc=null, pdfBytes=null;
let pages = []; // {num, viewportWidth, viewportHeight, canvas, ctx, layer}
let annotations = {}; // {pageNum: [ {id,type,x,y,content/styles/thread} ]}
let currentTool = 'select'; // select | textOnce | commentOnce | signatureOnce
let currentScale = 1; // CSS units
const ZOOMS = [0.25,0.5,0.75,0.9,1,1.1,1.25,1.5,1.75,2];
let fitWidthMode = false;
let readerMode = false;
let spread2 = false;
let currentPageIndex = 0; // 0-based for paging in reader
let dpr = window.devicePixelRatio || 1;
let signatureDataUrl = null;
let nextAnnoId = 1;
let openCommentTarget = null; // {pageNum, anno}

/* ----------------- DOM ----------------- */
const el = (id)=>document.getElementById(id);
const pagesEl = el('pages');
const mainEl = el('main');
const openBtn = el('openBtn');
const fileInput = el('file');
const saveBtn = el('saveBtn');
const textTool = el('textTool');
const commentTool = el('commentTool');
const signatureTool = el('signatureTool');
const zoomOutBtn = el('zoomOutBtn');
const zoomInBtn = el('zoomInBtn');
const fitWidthBtn = el('fitWidthBtn');
const toggleReaderBtn= el('toggleReaderBtn');
const toggleSpreadBtn= el('toggleSpreadBtn');
const prevPageBtn = el('prevPageBtn');
const nextPageBtn = el('nextPageBtn');
const pageInfo = el('pageInfo');
const textStylePanel = el('textStylePanel');
const textFontFamily = el('textFontFamily');
const textFontSize = el('textFontSize');
const textBoldBtn = el('textBoldBtn');
const textItalicBtn = el('textItalicBtn');
const textColor = el('textColor');
const signatureModal = el('signatureModal');
const signatureCanvas = el('signatureCanvas');
const signatureClose = el('signatureClose');
const signatureClear = el('signatureClear');
const signatureSave = el('signatureSave');
const sigCtx = signatureCanvas.getContext('2d');
const cs = {
  panel: el('commentSidebar'),
  title: el('csTitle'),
  thread: el('csThread'),
  author: el('csAuthor'),
  text: el('csText'),
  post: el('csPost'),
  close: el('csClose'),
  hide: el('csReplyClose')
};

/* ----------------- Helpers ----------------- */
function clamp(i,min,max){return Math.max(min,Math.min(max,i));}
function snapIndexFromScale(scale){ // nearest index
  let best=0, diff=1e9;
  for(let i=0;i<ZOOMS.length;i++){ const d=Math.abs(ZOOMS[i]-scale); if(d<diff){diff=d;best=i;}}
  return best;
}
function setTool(name){
  currentTool = name;
  // visual emphasis (toggle class on icons)
  [textTool,commentTool,signatureTool].forEach(b=>b && b.classList.remove('active'));
  if(name==='textOnce' && textTool) textTool.classList.add('active');
  if(name==='commentOnce' && commentTool) commentTool.classList.add('active');
  if(name==='signatureOnce' && signatureTool) signatureTool.classList.add('active');
}
function updatePageInfo(){
  const pct = Math.round(currentScale*100);
  const pageCount = pdfDoc? pdfDoc.numPages : 1;
  const pageNum = clamp(currentPageIndex+1,1,pageCount);
  pageInfo.textContent = `${pageNum} / ${pageCount} · ${pct}%`;
}
function inchToPx(v){return v*96;}
function toRgb(hex){const r=parseInt(hex.substr(1,2),16)/255,g=parseInt(hex.substr(3,2),16)/255,b=parseInt(hex.substr(5,2),16)/255;return {r,g,b};}
function ensurePageSlot(num){
  let slot = pages[num-1];
  if(slot) return slot;
  slot = { num, canvas: document.createElement('canvas'), ctx: null, layer: document.createElement('div'), vw:0, vh:0 };
  slot.layer.className='layer';
  const wrap = document.createElement('div'); wrap.className='page'; wrap.dataset.page=num;
  wrap.appendChild(slot.canvas); wrap.appendChild(slot.layer);
  pagesEl.appendChild(wrap);
  slot.ctx = slot.canvas.getContext('2d');
  pages[num-1] = slot;
  attachLayerEvents(slot.layer, num);
  return slot;
}
function anchorScrollBefore(){ // returns normalized position of top in document
  const total = pagesEl.scrollHeight - mainEl.clientHeight;
  return total>0 ? mainEl.scrollTop/total : 0;
}
function restoreScroll(pos){
  const total = pagesEl.scrollHeight - mainEl.clientHeight;
  mainEl.scrollTop = pos*total;
}

/* ----------------- Rendering ----------------- */
async function renderPage(num){
  const page = await pdfDoc.getPage(num);
  const viewport = page.getViewport({ scale: currentScale });
  const slot = ensurePageSlot(num);
  slot.vw = viewport.width; slot.vh = viewport.height;
  // CSS size
  slot.canvas.style.width = `${viewport.width}px`;
  slot.canvas.style.height = `${viewport.height}px`;
  // device pixels
  const realW = Math.floor(viewport.width * dpr);
  const realH = Math.floor(viewport.height * dpr);
  if (slot.canvas.width !== realW || slot.canvas.height !== realH){
    slot.canvas.width = realW; slot.canvas.height = realH;
  }
  slot.layer.style.width = `${viewport.width}px`;
  slot.layer.style.height = `${viewport.height}px`;

  const t = [dpr,0,0,dpr,0,0];
  await page.render({ canvasContext: slot.ctx, viewport, transform: t }).promise;
}
async function renderAll(){
  if(!pdfDoc) return;
  const keep = anchorScrollBefore();
  pagesEl.innerHTML=''; pages.length=0;
  for(let i=1;i<=pdfDoc.numPages;i++) await renderPage(i);
  restoreScroll(keep);
  updatePageInfo();
}

/* ----------------- Events: open/save ----------------- */
openBtn.onclick = ()=>fileInput.click();
fileInput.onchange = async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const buf = await f.arrayBuffer();
  pdfBytes = new Uint8Array(buf);
  const loading = pdfjsLib.getDocument({ data: pdfBytes });
  pdfDoc = await loading.promise;
  annotations = {};
  currentScale = 1; fitWidthMode=false; readerMode=false; spread2=false; currentPageIndex=0;
  await renderAll();
  saveBtn.disabled=false;
  setTool('select');
  hideTextToolbar();
};
saveBtn.onclick = async ()=>{
  if(!pdfBytes){alert('Open a PDF first.');return;}
  try{
    const doc = await PDFLib.PDFDocument.load(pdfBytes);
    const helv = await doc.embedFont(PDFLib.StandardFonts.Helvetica);
    const helvB = await doc.embedFont(PDFLib.StandardFonts.HelveticaBold);
    const times = await doc.embedFont(PDFLib.StandardFonts.TimesRoman);
    const cour = await doc.embedFont(PDFLib.StandardFonts.Courier);

    const N=PDFLib.PDFName, S=PDFLib.PDFString, Num=PDFLib.PDFNumber;
    const addTextAnnot = (page, x,y,w,h, contents, author)=>{
      const rect = doc.context.obj([Num.of(x),Num.of(y),Num.of(x+w),Num.of(y+h)]);
      const annot = doc.context.obj({
        Type:N.of('Annot'), Subtype:N.of('Text'), Rect:rect,
        Contents:S.of(contents||''), T:S.of(author||''),
        C: doc.context.obj([Num.of(1),Num.of(0.85),Num.of(0.35)]),
        Name:N.of('Comment'), F: Num.of(4)
      });
      const ref = doc.context.register(annot);
      const arr = page.node.get(N.of('Annots'));
      if(arr) arr.push(ref); else page.node.set(N.of('Annots'), doc.context.obj([ref]));
    };

    const pagesLib = doc.getPages();
    for(const key in annotations){
      const list = annotations[key]; if(!list || !list.length) continue;
      const pIndex = parseInt(key,10)-1;
      const page = pagesLib[pIndex]; const {height:ph} = page.getSize();
      for(const a of list){
        if(a.type==='text' && a.content && a.content.trim()){
          let font = helv;
          if(a.styles?.fontFamily?.includes('Times')) font=times;
          else if(a.styles?.fontFamily?.includes('Courier')) font=cour;
          else if(a.styles?.fontWeight==='bold') font=helvB;
          const size = parseInt(a.styles?.fontSize||'12',10);
          const col = toRgb(a.styles?.color||'#000000');
          page.drawText(a.content, { x:a.x, y: ph - a.y - size, size, font, color: PDFLib.rgb(col.r,col.g,col.b)});
        } else if(a.type==='signature' && a.dataUrl){
          const img = await doc.embedPng(a.dataUrl);
          const w = a.w || 200, h = a.h || 80;
          page.drawImage(img, { x:a.x, y: ph - a.y - h, width:w, height:h });
        } else if(a.type==='comment' && (a.thread?.length||0)>0){
          // combine thread into a popup string
          const msg = a.thread.map(c => `${c.author||'User'} (${c.time||''}):\n${c.text||''}`).join('\n\n');
          addTextAnnot(page, a.x, ph - a.y - 24, 24, 24, msg, a.thread[0]?.author || '');
        }
      }
    }
    const out = await doc.save();
    const blob = new Blob([out], {type:'application/pdf'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='annotated.pdf'; a.click(); URL.revokeObjectURL(url);
  }catch(err){
    alert('Save failed: '+err.message);
    console.error(err);
  }
};

/* ----------------- Tools ----------------- */
textTool.onclick = ()=>setTool('textOnce');
commentTool.onclick = ()=>setTool('commentOnce');

function openSignatureModal(){
  signatureModal.classList.remove('hidden');
  sigCtx.clearRect(0,0,signatureCanvas.width, signatureCanvas.height);
  sigDrawing=false;
  const existing = signatureDataUrl;
  if(existing){
    const img = new Image();
    img.onload = ()=>{ sigCtx.clearRect(0,0,signatureCanvas.width,signatureCanvas.height); sigCtx.drawImage(img,0,0,signatureCanvas.width,signatureCanvas.height); };
    img.src = existing;
  }
  setTool('select');
}
function closeSignatureModal(){
  signatureModal.classList.add('hidden');
}

if(signatureTool){
  signatureTool.onclick = ()=>{
    if(!signatureDataUrl){
      openSignatureModal();
    }else{
      setTool('signatureOnce');
    }
  };
  signatureTool.addEventListener('contextmenu',(e)=>{ e.preventDefault(); openSignatureModal(); });
}

/* Layer click for placing one-shot items */
function attachLayerEvents(layer, pageNum){
  layer.addEventListener('click', (e)=>{
    if(e.target!==layer) return;
    const rect = layer.getBoundingClientRect();
    const x = e.clientX - rect.left; const y = e.clientY - rect.top;
    if(currentTool==='textOnce'){
      const anno = { id: nextAnnoId++, type:'text', x, y, content:'', styles:{fontFamily:'Helvetica',fontSize:'12',fontWeight:'normal',fontStyle:'normal',color:'#000000'} };
      addAnnotationElement(layer, pageNum, anno, true);
      setTool('select'); // one-shot
    } else if(currentTool==='commentOnce'){
      const anno = { id: nextAnnoId++, type:'comment', x, y, thread:[] };
      addAnnotationElement(layer, pageNum, anno, true);
      openCommentUI(pageNum, anno);
      setTool('select');
    } else if(currentTool==='signatureOnce' && signatureDataUrl){
      const anno = { id: nextAnnoId++, type:'signature', x, y, w:200, h:80, dataUrl: signatureDataUrl };
      addAnnotationElement(layer, pageNum, anno, true);
      setTool('select');
    }
  });
}

/* Create DOM for annotation & register */
function addAnnotationElement(layer, pageNum, anno, addToState){
  if(addToState){
    if(!annotations[pageNum]) annotations[pageNum]=[];
    annotations[pageNum].push(anno);
  }
  if(anno.type==='text'){
    const div = document.createElement('div'); div.className='text-anno'; div.contentEditable=true; div.dataset.id=anno.id;
    div.style.left = anno.x+'px'; div.style.top = anno.y+'px'; div.style.minWidth='120px'; div.style.minHeight='24px';
    div.style.fontFamily = anno.styles.fontFamily; div.style.fontSize = (parseInt(anno.styles.fontSize,10)||12)+'px';
    div.style.fontWeight = anno.styles.fontWeight; div.style.fontStyle=anno.styles.fontStyle; div.style.color = anno.styles.color||'#000';
    div.placeholder = 'Type…';
    div.oninput = ()=> { anno.content = div.textContent; };
    div.addEventListener('focus',()=>showTextToolbar(div, anno));
    div.addEventListener('click',()=>showTextToolbar(div, anno));
    makeDraggable(div, anno, layer);
    layer.appendChild(div);
    div.focus();
  } else if(anno.type==='comment'){
    const pin = document.createElement('div'); pin.className='comment-pin'; pin.textContent='C'; pin.dataset.id=anno.id;
    pin.style.left = (anno.x-11)+'px'; pin.style.top=(anno.y-11)+'px';
    pin.onclick = (ev)=>{ ev.stopPropagation(); openCommentUI(pageNum, anno); };
    makeDraggable(pin, anno, layer, true);
    layer.appendChild(pin);
  } else if(anno.type==='signature'){
    const box = document.createElement('div'); box.className='sig-anno'; box.dataset.id=anno.id;
    box.style.left=anno.x+'px'; box.style.top=anno.y+'px'; box.style.width=(anno.w||200)+'px'; box.style.height=(anno.h||80)+'px';
    const img = document.createElement('img'); img.src=anno.dataUrl; box.appendChild(img);
    makeDraggable(box, anno, layer);
    layer.appendChild(box);
  }
}

/* Dragging */
function makeDraggable(el, anno, layer, isPin=false){
  let dragging=false,sx=0,sy=0, origL=0,origT=0;
  el.addEventListener('mousedown',(e)=>{ if(e.target!==el) return; dragging=true; sx=e.clientX; sy=e.clientY; origL=parseFloat(el.style.left); origT=parseFloat(el.style.top); e.preventDefault(); if(el.classList.contains('text-anno')) hideTextToolbar(); });
  window.addEventListener('mousemove',(e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; el.style.left=(origL+dx)+'px'; el.style.top=(origT+dy)+'px'; if(isPin){ anno.x=parseFloat(el.style.left)+11; anno.y=parseFloat(el.style.top)+11; } else { anno.x=parseFloat(el.style.left); anno.y=parseFloat(el.style.top);} if(el.classList.contains('text-anno')) positionTextToolbar(el); });
  window.addEventListener('mouseup',()=>dragging=false);
}

/* ----------------- Comment UI (right sidebar) ----------------- */
function openCommentUI(pageNum, anno){
  openCommentTarget = {pageNum, anno};
  cs.panel.classList.add('open');
  cs.thread.innerHTML='';
  cs.title.textContent = `Comments (p.${pageNum})`;
  cs.author.value = localStorage.getItem('commentAuthor')||'';
  if(anno.thread && anno.thread.length){
    for(const c of anno.thread){
      const div = document.createElement('div'); div.className='cs-item';
      div.innerHTML = `<div class="cs-author">${c.author||'User'}</div>
        <div class="cs-text">${(c.text||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
        <div class="cs-time">${c.time||''}</div>`;
      cs.thread.appendChild(div);
    }
    cs.thread.scrollTop = cs.thread.scrollHeight;
  }
  cs.text.focus();
}
function closeCommentUI(){
  cs.panel.classList.remove('open');
  openCommentTarget = null;
}
cs.post.onclick = ()=>{
  if(!openCommentTarget) return;
  const author = cs.author.value.trim()||'User';
  const text = cs.text.value.trim(); if(!text) return;
  localStorage.setItem('commentAuthor', author);
  const c = {author, text, time: new Date().toLocaleString()};
  const {pageNum, anno} = openCommentTarget;
  if(!anno.thread) anno.thread=[]; anno.thread.push(c);
  cs.text.value='';
  openCommentUI(pageNum, anno);
};
cs.close.onclick = closeCommentUI;
cs.hide.onclick = closeCommentUI;

/* Close sidebar when clicking outside */
document.addEventListener('click',(e)=>{
  if(!cs.panel.contains(e.target) && !e.target.classList.contains('comment-pin')){
    // Do nothing; user previously wanted close-on-click, but here we keep it manual to avoid instant-close.
  }
}, true);

/* ----------------- Zoom & layout ----------------- */
function setScale(scale){
  currentScale = scale; fitWidthMode=false;
  renderAll();
}
zoomInBtn.onclick = ()=>{
  const idx = snapIndexFromScale(currentScale);
  const next = clamp(idx+1,0,ZOOMS.length-1);
  setScale(ZOOMS[next]);
};
zoomOutBtn.onclick = ()=>{
  const idx = snapIndexFromScale(currentScale);
  const prev = clamp(idx-1,0,ZOOMS.length-1);
  setScale(ZOOMS[prev]);
};
fitWidthBtn.onclick = ()=>{
  if(!pdfDoc) return;
  // fit first page width
  pdfDoc.getPage(1).then(page=>{
    const vw = page.getViewport({scale:1}).width;
    const target = mainEl.clientWidth - 40; // padding
    let scale = Math.max(0.25, Math.min(2, target / vw));
    currentScale = scale; fitWidthMode=true;
    renderAll();
  });
};

/* ----------------- Reader Mode & paging ----------------- */
function applyReaderLayout(){
  document.body.classList.toggle('reader', readerMode);
  // In reader mode, show only the current page (or pair), hide others
  const pc = pdfDoc ? pdfDoc.numPages : 0;
  pagesEl.querySelectorAll('.page').forEach((wrap)=>{ wrap.style.display='none'; });
  if(!pdfDoc) return;
  if(!readerMode){
    // show all
    pagesEl.querySelectorAll('.page').forEach((wrap)=> wrap.style.display='block');
    return;
  }
  if(!spread2){
    // single
    const p = clamp(currentPageIndex+1,1,pc);
    const wrap = pagesEl.querySelector(`.page[data-page="${p}"]`);
    if(wrap){ wrap.style.display='block'; }
  }else{
    const p1 = clamp(currentPageIndex+1,1,pc);
    const p2 = clamp(p1+1,1,pc);
    const w1 = pagesEl.querySelector(`.page[data-page="${p1}"]`);
    const w2 = pagesEl.querySelector(`.page[data-page="${p2}"]`);
    if(w1){ w1.style.display='inline-block'; w1.style.marginRight='8px'; }
    if(w2){ w2.style.display='inline-block'; }
  }
}
function toggleReader(){
  readerMode = !readerMode;
  applyReaderLayout();
  updatePageInfo();
  // Fullscreen request/exit
  if(readerMode){
    if(document.fullscreenElement==null){
      (document.documentElement.requestFullscreen && document.documentElement.requestFullscreen());
    }
  }else{
    if(document.fullscreenElement) document.exitFullscreen();
  }
}
toggleReaderBtn.onclick = toggleReader;
toggleSpreadBtn.onclick = ()=>{ spread2 = !spread2; if(readerMode) applyReaderLayout(); };

/* Page navigation */
function goToPage(delta){
  if(!pdfDoc) return;
  currentPageIndex = clamp(currentPageIndex+delta,0,pdfDoc.numPages-1);
  if(readerMode){
    applyReaderLayout();
  }else{
    const target = pagesEl.querySelector(`.page[data-page="${currentPageIndex+1}"]`);
    if(target){
      target.scrollIntoView({behavior:'smooth',block:'start'});
    }
  }
  updatePageInfo();
}
if (prevPageBtn) prevPageBtn.onclick = ()=>goToPage(-1);
if (nextPageBtn) nextPageBtn.onclick = ()=>goToPage(1);

/* ----------------- Keyboard ----------------- */
document.addEventListener('keydown',(e)=>{
  if(e.key==='f' || e.key==='F'){ e.preventDefault(); toggleReader(); return; }
  if(e.key==='+'){ zoomInBtn.click(); }
  if(e.key==='-'){ zoomOutBtn.click(); }
  if(e.key==='Escape'){
    setTool('select');
    hideTextToolbar();
    if(!signatureModal.classList.contains('hidden')) closeSignatureModal();
  }
  if(readerMode){
    if(e.key==='ArrowLeft'){ e.preventDefault(); goToPage(-1); }
    if(e.key==='ArrowRight'){ e.preventDefault(); goToPage(1); }
    // up/down: allow native scroll
  } else {
    // tool shortcuts
    if((e.key==='t' || e.key==='T') && textTool){ textTool.click(); }
    if((e.key==='m' || e.key==='M') && commentTool){ commentTool.click(); }
    if((e.key==='s' || e.key==='S') && signatureTool){ signatureTool.click(); }
    if(e.key==='ArrowLeft'){ e.preventDefault(); goToPage(-1); }
    if(e.key==='ArrowRight'){ e.preventDefault(); goToPage(1); }
  }
});

/* ----------------- Text toolbar logic ----------------- */
let textToolbarTarget = null;
let textToolbarAnno = null;

function positionTextToolbar(el){
  if(!textToolbarTarget) return;
  const rect = el.getBoundingClientRect();
  const panelRect = textStylePanel.getBoundingClientRect();
  const panelHeight = panelRect.height || textStylePanel.offsetHeight || 0;
  const panelWidth = panelRect.width || textStylePanel.offsetWidth || 0;
  let top = window.scrollY + rect.top - panelHeight - 8;
  let left = window.scrollX + rect.left;
  if(top < 8){
    top = window.scrollY + rect.bottom + 8;
  }
  const maxLeft = window.scrollX + document.documentElement.clientWidth - panelWidth - 8;
  if(left > maxLeft){
    left = maxLeft;
  }
  textStylePanel.style.top = Math.max(8, top)+'px';
  textStylePanel.style.left = Math.max(8, left)+'px';
}

function showTextToolbar(el, anno){
  textToolbarTarget = el;
  textToolbarAnno = anno;
  textFontFamily.value = anno.styles.fontFamily || 'Helvetica';
  textFontSize.value = parseInt(anno.styles.fontSize,10)||12;
  textBoldBtn.classList.toggle('active', anno.styles.fontWeight==='bold');
  textItalicBtn.classList.toggle('active', anno.styles.fontStyle==='italic');
  textColor.value = anno.styles.color || '#000000';
  textStylePanel.classList.remove('hidden');
  positionTextToolbar(el);
}

function hideTextToolbar(){
  textToolbarTarget = null;
  textToolbarAnno = null;
  textStylePanel.classList.add('hidden');
}

textFontFamily.addEventListener('change',()=>{
  if(!textToolbarTarget||!textToolbarAnno) return;
  textToolbarAnno.styles.fontFamily = textFontFamily.value;
  textToolbarTarget.style.fontFamily = textFontFamily.value;
});

textFontSize.addEventListener('change',()=>{
  if(!textToolbarTarget||!textToolbarAnno) return;
  const size = clamp(parseInt(textFontSize.value,10)||12,8,96);
  textToolbarAnno.styles.fontSize = String(size);
  textToolbarTarget.style.fontSize = size+'px';
});

textBoldBtn.addEventListener('click',(e)=>{
  e.preventDefault();
  if(!textToolbarTarget||!textToolbarAnno) return;
  const isBold = textToolbarAnno.styles.fontWeight==='bold';
  textToolbarAnno.styles.fontWeight = isBold?'normal':'bold';
  textToolbarTarget.style.fontWeight = textToolbarAnno.styles.fontWeight;
  textBoldBtn.classList.toggle('active', !isBold);
});

textItalicBtn.addEventListener('click',(e)=>{
  e.preventDefault();
  if(!textToolbarTarget||!textToolbarAnno) return;
  const isItalic = textToolbarAnno.styles.fontStyle==='italic';
  textToolbarAnno.styles.fontStyle = isItalic?'normal':'italic';
  textToolbarTarget.style.fontStyle = textToolbarAnno.styles.fontStyle;
  textItalicBtn.classList.toggle('active', !isItalic);
});

textColor.addEventListener('input',()=>{
  if(!textToolbarTarget||!textToolbarAnno) return;
  textToolbarAnno.styles.color = textColor.value;
  textToolbarTarget.style.color = textColor.value;
});

document.addEventListener('click',(e)=>{
  if(textStylePanel.contains(e.target) || (textToolbarTarget && textToolbarTarget.contains(e.target))){
    return;
  }
  hideTextToolbar();
});

window.addEventListener('scroll',()=>{
  if(textToolbarTarget) positionTextToolbar(textToolbarTarget);
});

/* ----------------- Signature modal ----------------- */
sigCtx.lineCap='round';
sigCtx.lineJoin='round';
sigCtx.lineWidth=2;
sigCtx.strokeStyle='#111';
let sigDrawing=false;

signatureCanvas.addEventListener('pointerdown',(e)=>{
  e.preventDefault();
  sigDrawing=true;
  signatureCanvas.setPointerCapture(e.pointerId);
  sigCtx.beginPath();
  sigCtx.moveTo(e.offsetX,e.offsetY);
});
signatureCanvas.addEventListener('pointermove',(e)=>{
  if(sigDrawing) e.preventDefault();
  if(!sigDrawing) return;
  sigCtx.lineTo(e.offsetX,e.offsetY);
  sigCtx.stroke();
});
['pointerup','pointerleave','pointercancel'].forEach(ev=>signatureCanvas.addEventListener(ev,(e)=>{
  if(ev==='pointerup' && signatureCanvas.hasPointerCapture(e.pointerId)) signatureCanvas.releasePointerCapture(e.pointerId);
  sigDrawing=false;
}));

signatureClear.onclick = ()=>{
  sigCtx.clearRect(0,0,signatureCanvas.width, signatureCanvas.height);
  sigDrawing=false;
};

signatureClose.onclick = ()=>{
  closeSignatureModal();
};

signatureSave.onclick = ()=>{
  signatureDataUrl = signatureCanvas.toDataURL('image/png');
  closeSignatureModal();
  setTool('signatureOnce');
};

signatureModal.addEventListener('click',(e)=>{
  if(e.target===signatureModal) closeSignatureModal();
});

// default tool state highlight
setTool('select');

/* ----------------- Load via ?src= ----------------- */
(function(){
  const u = new URL(location.href);
  const src = u.searchParams.get('src');
  if(!src) return;
  fetch(src).then(r=>r.arrayBuffer()).then(async(buf)=>{
    pdfBytes = new Uint8Array(buf);
    const loading = pdfjsLib.getDocument({ data: pdfBytes });
    pdfDoc = await loading.promise;
    await renderAll();
    saveBtn.disabled = false;
  }).catch(console.error);
})();

</script>
</body>
</html>
